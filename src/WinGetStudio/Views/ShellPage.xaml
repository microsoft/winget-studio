<Page
    x:Class="WinGetStudio.Views.ShellPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:WinGetStudio.ViewModels"
    xmlns:helpers="using:WinGetStudio.Helpers"
    xmlns:behaviors="using:WinGetStudio.Behaviors"
    xmlns:i="using:Microsoft.Xaml.Interactivity"
    xmlns:notifications="using:WingetStudio.Services.VisualFeedback.Models" xmlns:converters="using:CommunityToolkit.WinUI.Converters"
    Loaded="OnLoaded">

    <Page.Resources>
        <converters:DoubleToVisibilityConverter x:Key="CountToVisibilityConverter" GreaterThan="0" FalseValue="Collapsed" TrueValue="Visible" />
    </Page.Resources>
    
    <i:Interaction.Behaviors>
        <i:EventTriggerBehavior EventName="Loaded">
            <i:InvokeCommandAction Command="{x:Bind ViewModel.LoadedCommand}" />
        </i:EventTriggerBehavior>
        <i:EventTriggerBehavior EventName="Unloaded">
            <i:InvokeCommandAction Command="{x:Bind ViewModel.UnloadedCommand}" />
        </i:EventTriggerBehavior>
    </i:Interaction.Behaviors>

    <Grid>
        <Grid x:Name="AppTitleBar"
              Canvas.ZIndex="1"
              Height="{Binding ElementName=NavigationViewControl, Path=CompactPaneLength}"
              IsHitTestVisible="True"
              VerticalAlignment="Top">
            <Image Source="/Assets/Icons/WinGetStudio.ico"
                   HorizontalAlignment="Left"
                   Width="16"
                   Height="16" />
            <TextBlock x:Name="AppTitleBarText"
                       VerticalAlignment="Center"
                       TextWrapping="NoWrap"
                       Style="{StaticResource CaptionTextBlockStyle}"
                       Margin="28,0,0,0"/>
        </Grid>

        <Grid VerticalAlignment="Top"
              Height="{Binding ElementName=NavigationViewControl, Path=CompactPaneLength}">
            <ProgressBar Value="{x:Bind ViewModel.ProgressValue, Mode=OneWay}"
                         IsIndeterminate="{x:Bind ViewModel.IsProgressIndeterminate, Mode=OneWay}"
                         Visibility="{x:Bind ViewModel.IsProgressVisible, Mode=OneWay}"
                         VerticalAlignment="Bottom" />
        </Grid>

        <SplitView x:Name="SplitView"
                   DisplayMode="CompactInline"
                   CompactPaneLength="0"
                   IsPaneOpen="{x:Bind ViewModel.IsSplitViewPaneOpen, Mode=TwoWay}"
                   PaneBackground="Transparent"
                   PanePlacement="Right">
            <SplitView.Pane>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <Grid Height="{Binding ElementName=NavigationViewControl, Path=CompactPaneLength}" />
                    <Grid Grid.Row="1" Padding="12" Background="{ThemeResource SystemChromeMediumLowColor}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="auto" />
                                <RowDefinition Height="auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>
                            <TextBlock Style="{ThemeResource SubtitleTextBlockStyle}">Notifications</TextBlock>
                            <HyperlinkButton Grid.Row="1"
                                             Style="{ThemeResource TextBlockButtonStyle}">Show all notifications</HyperlinkButton>
                            <ScrollViewer Grid.Row="2">
                                <StackPanel Grid.Row="2" Spacing="12">
                                    <!-- Unread notifications section -->
                                    <ListView ItemsSource="{x:Bind ViewModel.UnreadNotifications}"
                                              SelectionMode="None">
                                        <ListView.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel Spacing="4" />
                                            </ItemsPanelTemplate>
                                        </ListView.ItemsPanel>
                                        <ListView.ItemContainerStyle>
                                            <Style TargetType="ListViewItem">
                                                <Setter Property="Padding" Value="0" />
                                                <Setter Property="Margin" Value="0" />
                                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                            </Style>
                                        </ListView.ItemContainerStyle>
                                        <ListView.ItemTemplate>
                                            <DataTemplate x:DataType="notifications:NotificationMessage">
                                                <InfoBar IsOpen="True"
                                                         IsClosable="False"
                                                         Severity="Informational"
                                                         IsIconVisible="False"
                                                         Title="{x:Bind Title}"
                                                         Message="{x:Bind Message}" />
                                            </DataTemplate>
                                        </ListView.ItemTemplate>
                                    </ListView>

                                    <!-- Previous notifications section -->
                                    <StackPanel Spacing="12"
                                                Visibility="{x:Bind ViewModel.PreviousNotifications.Count, Mode=OneWay, Converter={StaticResource CountToVisibilityConverter}}">
                                        <NavigationViewItemSeparator />
                                        <TextBlock Style="{ThemeResource BodyTextBlockStyle}" Foreground="{ThemeResource TextFillColorSecondaryBrush}" HorizontalAlignment="Center">Previous notifications</TextBlock>
                                        <ListView ItemsSource="{x:Bind ViewModel.PreviousNotifications}"
                                              SelectionMode="None">
                                            <ListView.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Spacing="4" />
                                                </ItemsPanelTemplate>
                                            </ListView.ItemsPanel>
                                            <ListView.ItemContainerStyle>
                                                <Style TargetType="ListViewItem">
                                                    <Setter Property="Padding" Value="0" />
                                                    <Setter Property="Margin" Value="0" />
                                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                                </Style>
                                            </ListView.ItemContainerStyle>
                                            <ListView.ItemTemplate>
                                                <DataTemplate x:DataType="notifications:NotificationMessage">
                                                    <InfoBar IsOpen="True"
                                                         IsClosable="False"
                                                         Severity="Informational"
                                                         IsIconVisible="False"
                                                         Title="{x:Bind Title}"
                                                         Message="{x:Bind Message}" />
                                                </DataTemplate>
                                            </ListView.ItemTemplate>
                                        </ListView>
                                    </StackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </Grid>
                    </Grid>
                </Grid>
            </SplitView.Pane>

            <NavigationView
                x:Name="NavigationViewControl"
                Canvas.ZIndex="0"
                IsBackButtonVisible="Visible"
                IsBackEnabled="{x:Bind ViewModel.IsBackEnabled, Mode=OneWay}"
                SelectedItem="{x:Bind ViewModel.Selected, Mode=OneWay}"
                IsSettingsVisible="True"
                ExpandedModeThresholdWidth="1280"
                DisplayModeChanged="NavigationViewControl_DisplayModeChanged"
                Header="{x:Bind ((ContentControl)ViewModel.Selected).Content, Mode=OneWay}">
                <NavigationView.MenuItems>
                    <NavigationViewItem x:Uid="Shell_Main" helpers:NavigationHelper.NavigateTo="viewmodels:MainViewModel">
                        <NavigationViewItem.Icon>
                            <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="&#xE80F;"/>
                        </NavigationViewItem.Icon>
                    </NavigationViewItem>
                    <NavigationViewItem x:Uid="Shell_Configuration" helpers:NavigationHelper.NavigateTo="viewmodels:ConfigurationViewModel">
                        <NavigationViewItem.Icon>
                            <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="&#xE8FF;"/>
                        </NavigationViewItem.Icon>
                    </NavigationViewItem>
                    <NavigationViewItem x:Uid="Shell_Validation" helpers:NavigationHelper.NavigateTo="viewmodels:ValidationFrameViewModel">
                        <NavigationViewItem.Icon>
                            <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="&#xE762;"/>
                        </NavigationViewItem.Icon>
                    </NavigationViewItem>
                </NavigationView.MenuItems>

                <NavigationView.HeaderTemplate>
                    <DataTemplate>
                        <Grid>
                            <TextBlock
                                Text="{Binding}"
                                Style="{ThemeResource TitleTextBlockStyle}" />
                        </Grid>
                    </DataTemplate>
                </NavigationView.HeaderTemplate>

                <NavigationView.FooterMenuItems>
                    <NavigationViewItem SelectsOnInvoked="False" Content="Notifications">
                        <i:Interaction.Behaviors>
                            <i:EventTriggerBehavior EventName="Tapped">
                                <i:InvokeCommandAction Command="{x:Bind ViewModel.ToggleSplitViewPanelCommand}" />
                            </i:EventTriggerBehavior>
                        </i:Interaction.Behaviors>
                        <NavigationViewItem.Icon>
                            <FontIcon FontFamily="{StaticResource SymbolThemeFontFamily}" Glyph="&#xEDAC;"/>
                        </NavigationViewItem.Icon>
                        <NavigationViewItem.InfoBadge>
                            <InfoBadge Value="100" />
                        </NavigationViewItem.InfoBadge>
                    </NavigationViewItem>
                </NavigationView.FooterMenuItems>

                <i:Interaction.Behaviors>
                    <behaviors:NavigationViewHeaderBehavior
                    DefaultHeader="{x:Bind ((ContentControl)ViewModel.Selected).Content, Mode=OneWay}">
                        <behaviors:NavigationViewHeaderBehavior.DefaultHeaderTemplate>
                            <DataTemplate>
                                <Grid>
                                    <TextBlock
                                    Text="{Binding}"
                                    Style="{ThemeResource TitleTextBlockStyle}" />
                                </Grid>
                            </DataTemplate>
                        </behaviors:NavigationViewHeaderBehavior.DefaultHeaderTemplate>
                    </behaviors:NavigationViewHeaderBehavior>
                </i:Interaction.Behaviors>
                <Grid Margin="{StaticResource NavigationViewPageContentMargin}">
                    <Frame x:Name="NavigationFrame" />
                    <!-- DEBUG -->
                    <StackPanel VerticalAlignment="Bottom" Orientation="Horizontal" Spacing="4">
                        <Button Click="Progress_Visibility">Toggle progress bar visibility</Button>
                        <Button Click="Progress_Indeterminate">Toggle progress indeterminate</Button>
                        <Button Click="Progress_Value">Set progress value</Button>
                        <Button Click="Notification_Add">Add notification</Button>
                        <Button Click="Notification_Read">Mark all notification read</Button>
                    </StackPanel>
                </Grid>
            </NavigationView>
        </SplitView>
    </Grid>
</Page>
