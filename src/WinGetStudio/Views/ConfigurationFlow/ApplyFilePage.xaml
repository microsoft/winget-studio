<Page
    x:Class="WinGetStudio.Views.ConfigurationFlow.ApplyFilePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:WinGetStudio.Views.ConfigurationFlow"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:labs="using:CommunityToolkit.Labs.WinUI"
    xmlns:converters="using:CommunityToolkit.WinUI.Converters"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:models="using:WinGetStudio.Models"
    xmlns:i="using:Microsoft.Xaml.Interactivity"
    xmlns:localControls="using:WinGetStudio.Views.Controls"
    mc:Ignorable="d">
    <Page.Resources>
        <converters:StringVisibilityConverter x:Key="StringVisibilityConverter" />
        <x:Double x:Key="ActionButtonMinWidth">120</x:Double>
    </Page.Resources>

    <i:Interaction.Behaviors>
        <i:EventTriggerBehavior EventName="Loaded">
            <i:InvokeCommandAction Command="{x:Bind ViewModel.LoadedCommand}" />
        </i:EventTriggerBehavior>
    </i:Interaction.Behaviors>

    <Grid RowSpacing="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="auto" />
        </Grid.RowDefinitions>

        <TextBlock Style="{ThemeResource SubtitleTextBlockStyle}">Applying Configuration File</TextBlock>
        <ScrollView Grid.Row="1" BorderThickness="0,1,0,0" BorderBrush="{ThemeResource ControlStrokeColorDefaultBrush}">
            <ItemsRepeater ItemsSource="{x:Bind ViewModel.ApplySet.Units, Mode=OneWay}">
                <ItemsRepeater.Layout>
                    <StackLayout Spacing="8" />
                </ItemsRepeater.Layout>
                <ItemsRepeater.ItemTemplate>
                    <DataTemplate x:DataType="models:ApplyUnitViewModel">
                        <Expander HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch" IsExpanded="{x:Bind IsExpanded, Mode=OneWay}">
                            <Expander.Header>
                                <StackPanel HorizontalAlignment="Left" Spacing="8" Orientation="Horizontal">
                                    <controls:SwitchPresenter Value="{x:Bind State, Mode=OneWay}" TargetType="models:ApplyUnitState">
                                        <controls:Case Value="Failed">
                                            <FontIcon Glyph="&#xEA39;" Foreground="{ThemeResource SystemFillColorCriticalBrush}" />
                                        </controls:Case>
                                        <controls:Case Value="Succeeded">
                                            <FontIcon Glyph="&#xE930;" Foreground="{ThemeResource SystemFillColorSuccessBrush}" />
                                        </controls:Case>
                                        <controls:Case Value="Skipped">
                                            <FontIcon Glyph="&#xE783;" Foreground="{ThemeResource SystemFillColorCautionBrush}" />
                                        </controls:Case>
                                        <controls:Case Value="InProgress">
                                            <ProgressRing Foreground="{ThemeResource AccentTextFillColorPrimaryBrush}"
                                                          Height="{ThemeResource BodyTextBlockFontSize}"
                                                          Width="{ThemeResource BodyTextBlockFontSize}"/>
                                        </controls:Case>
                                        <controls:Case Value="NotStarted">
                                            <FontIcon Glyph="&#xF138;" Foreground="{ThemeResource TextFillColorTertiaryBrush}" />
                                        </controls:Case>
                                    </controls:SwitchPresenter>
                                    <TextBlock Style="{ThemeResource BodyStrongTextBlockStyle}" Text="{x:Bind Title}" />
                                </StackPanel>
                            </Expander.Header>
                            <Expander.Content>
                                <controls:SwitchPresenter Value="{x:Bind IsLoading, Mode=OneWay}" TargetType="x:Boolean">
                                    <controls:Case Value="True">
                                        <localControls:ShimmerRepeater ItemCount="2">
                                            <localControls:ShimmerRepeater.Resources>
                                                <StaticResource x:Key="ShimmerHeight" ResourceKey="BodyTextBlockFontSize" />
                                            </localControls:ShimmerRepeater.Resources>
                                        </localControls:ShimmerRepeater>
                                    </controls:Case>
                                    <controls:Case Value="False">
                                        <StackPanel Spacing="8">
                                            <!-- Title with copy button-->
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="auto" />
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Text="{x:Bind Message, Mode=OneWay}"
                                                           IsTextSelectionEnabled="True"
                                                           TextTrimming="WordEllipsis"
                                                           VerticalAlignment="Center"
                                                           Visibility="{x:Bind Message, Converter={StaticResource StringVisibilityConverter}, Mode=OneWay}" />
                                                <Border Grid.Column="1"
                                                        HorizontalAlignment="Right"
                                                        Background="{ThemeResource ControlOnImageFillColorDefaultBrush}"
                                                        CornerRadius="{ThemeResource ControlCornerRadius}">
                                                    <localControls:CopyButton Tag="{x:Bind}" Click="CopyOutputMessage" Content="&#xE8C8;"/>
                                                </Border>
                                            </Grid>
                                            <!-- Detailed message -->
                                            <TextBlock Text="{x:Bind Description, Mode=OneWay}"
                                                       IsTextSelectionEnabled="True"
                                                       Visibility="{x:Bind Description, Converter={StaticResource StringVisibilityConverter}, Mode=OneWay}" />
                                        </StackPanel>
                                    </controls:Case>
                                </controls:SwitchPresenter>
                            </Expander.Content>
                        </Expander>
                    </DataTemplate>
                </ItemsRepeater.ItemTemplate>
            </ItemsRepeater>
        </ScrollView>

        <!-- Action buttons -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
            <Button x:Uid="ApplyFile_BackButton"
                    MinWidth="{StaticResource ActionButtonMinWidth}"
                    Command="{x:Bind ViewModel.BackCommand}" />
            <Button x:Uid="ApplyFile_CancelButton"
                    MinWidth="{StaticResource ActionButtonMinWidth}"
                    IsEnabled="{x:Bind ViewModel.ApplySet.CanCancel, Mode=OneWay}"
                    Click="CancelButton_Click" />
            <Button x:Uid="ApplyFile_DoneButton"
                    Style="{ThemeResource AccentButtonStyle}"
                    MinWidth="{StaticResource ActionButtonMinWidth}"
                    IsEnabled="{x:Bind ViewModel.ApplySet.IsDone, Mode=OneWay}"
                    Command="{x:Bind ViewModel.DoneCommand}" />
        </StackPanel>

        <!-- Cancel confirmation dialog -->
        <ContentDialog x:Name="CancelDialog"
                       x:Uid="ApplyFile_CancelDialog"
                       PrimaryButtonCommand="{x:Bind ViewModel.ApplySet.CancelCommand, Mode=OneWay}"
                       PrimaryButtonStyle="{ThemeResource AccentButtonStyle}" />
    </Grid>
</Page>
