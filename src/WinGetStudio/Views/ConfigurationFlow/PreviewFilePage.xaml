<Page
    x:Class="WinGetStudio.Views.ConfigurationFlow.PreviewFilePage"
    x:Name="RootPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:converters="using:CommunityToolkit.WinUI.Converters"
    xmlns:labs="using:CommunityToolkit.Labs.WinUI"
    xmlns:models="using:WinGetStudio.Models"
    xmlns:viewmodels="using:WinGetStudio.ViewModels"
    xmlns:i="using:Microsoft.Xaml.Interactivity"
    xmlns:ic="using:Microsoft.Xaml.Interactions.Core"
    xmlns:userControls="using:WinGetStudio.Views.Controls"
    mc:Ignorable="d">

    <Page.Resources>
        <ResourceDictionary>
            <converters:StringVisibilityConverter x:Key="StringVisibilityConverter"/>
            <converters:EmptyObjectToObjectConverter x:Key="EmptyObjectToVisibilityConverter" EmptyValue="Visible" NotEmptyValue="Collapsed"/>
            <converters:BoolToObjectConverter x:Key="BoolToVisibilityNegationConverter" TrueValue="Collapsed" FalseValue="Visible"/>
            <converters:BoolToObjectConverter x:Key="BoolToVisibilityConverter" TrueValue="Visible" FalseValue="Collapsed"/>

            <converters:CollectionVisibilityConverter x:Key="CollectionVisibilityConverter" />
            <converters:CollectionVisibilityConverter x:Key="CollectionNegativeVisibilityConverter" EmptyValue="Visible"  NotEmptyValue="Collapsed"/>
            <DataTemplate x:Key="KeyValueTemplate">
                <StackPanel Spacing="2"
                            Orientation="Horizontal"
                            Visibility="{Binding Value, Converter={StaticResource StringVisibilityConverter}}">
                    <TextBlock Style="{ThemeResource BodyStrongTextBlockStyle}" Text="{Binding Key}" />
                    <TextBlock Text=":" />
                    <TextBlock IsTextSelectionEnabled="True" Text="{Binding Value}" TextWrapping="WrapWholeWords" />
                </StackPanel>
            </DataTemplate>
            <Style TargetType="ListView" x:Key="KeyValueList">
                <Setter Property="SelectionMode" Value="None" />
                <Setter Property="ItemContainerStyle">
                    <Setter.Value>
                        <Style TargetType="ListViewItem" BasedOn="{StaticResource DefaultListViewItemStyle}">
                            <Setter Property="Margin" Value="0" />
                            <Setter Property="Padding" Value="0" />
                            <Setter Property="MinHeight" Value="0" />
                            <Setter Property="MinWidth" Value="0" />
                            <Setter Property="IsTabStop" Value="False" />
                        </Style>
                    </Setter.Value>
                </Setter>
            </Style>
            <Style TargetType="ListView" x:Key="KeyValueSubList" BasedOn="{StaticResource KeyValueList}">
                <Setter Property="Margin" Value="10,0" />
            </Style>
            <x:Double x:Key="SectionSpacing">10</x:Double>
            <Thickness x:Key="BlockThickness">0,0,0,5</Thickness>
        </ResourceDictionary>
    </Page.Resources>


    <Grid RowSpacing="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <ContentDialog
            x:Uid="PreviewPage_SaveDialog"
            x:Name="SaveDialog"
            PrimaryButtonCommand="{Binding SaveCommand}"
            SecondaryButtonCommand="{Binding SaveAsCommand}"
            CloseButtonCommand="{Binding DiscardCommand}">
            
        </ContentDialog>

        <ContentDialog
            x:Uid="PreviewPage_ApplyDialog"
            x:Name="ApplyDialog"
            PrimaryButtonCommand="{Binding ApplyCommand}">

        </ContentDialog>


        <TextBlock Margin="0,0,0,8" Grid.Row="0">
            <Run x:Uid="ManagePage_Description"/>
            <Hyperlink NavigateUri="https://learn.microsoft.com/en-us/powershell/dsc/concepts/configuration-documents/overview?view=dsc-3.0">
                <Run x:Uid="ManagePage_LearnMoreLink"/>
            </Hyperlink>
        </TextBlock>

        <Grid Grid.Row="1" RowSpacing="4" HorizontalAlignment="Stretch">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>


            <TextBlock x:Uid="ManagePage_SelectFileBoxHeader" FontWeight="Bold" Grid.Row="0"/>
            <TextBox
                PlaceholderText="C:\Users\user\configuration.winget"
                Text="{x:Bind ViewModel.FilePath, Mode=OneWay}"
                IsReadOnly="True"
                MinWidth="250"
                Padding="8"
                Grid.Row="1"
                Grid.Column="0"/>
            <Button
                Content="Browse"
                VerticalAlignment="Stretch"
                Margin="12,0"
                Padding="16,0"
                Command="{x:Bind ViewModel.BrowseCommand}"
                Grid.Row="1"
                Grid.Column="1"/>

            <StackPanel Orientation="Horizontal"
                        Spacing="8"
                        Grid.Row="1"
                        Grid.Column="3"
                        HorizontalAlignment="Left">
                <TextBlock x:Uid="ManagePage_EditModeLabel" VerticalAlignment="Center"/>
                <ToggleSwitch
                    IsOn="{x:Bind ViewModel.IsInEditMode, Mode=OneWay}"
                    OffContent=""
                    OnContent=""
                    MinWidth="0"
                    VerticalAlignment="Center"
                    Toggled="ShowSaveDialog">
                </ToggleSwitch>

            </StackPanel>
        </Grid>

        <Rectangle Height="1"
                   Fill="{ThemeResource SystemControlForegroundBaseLowBrush}"
                   HorizontalAlignment="Stretch"
                   Margin="0,8"
                   Grid.Row="2"/>

        <Grid Grid.Row="3" Visibility="{x:Bind ViewModel.IsInEditMode, Mode=OneWay, Converter={StaticResource BoolToVisibilityNegationConverter}}">
            <StackPanel Spacing="12" Visibility="{x:Bind ViewModel.LoadingUnits, Mode=OneWay}">
                <StackPanel.Resources>
                    <Style TargetType="labs:Shimmer">
                        <Setter Property="Height" Value="50" />
                    </Style>
                </StackPanel.Resources>
                <labs:Shimmer />
                <labs:Shimmer />
                <labs:Shimmer />
                <labs:Shimmer />
                <labs:Shimmer />
                <labs:Shimmer />
            </StackPanel>

            <ListView ItemsSource="{x:Bind ViewModel.ConfigurationUnits, Mode=OneWay}"
                      x:Name="ConfigurationUnitSections"
                      Style="{StaticResource KeyValueList}">
                <ListView.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Spacing="12" />
                    </ItemsPanelTemplate>
                </ListView.ItemsPanel>
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem" BasedOn="{StaticResource DefaultListViewItemStyle}">
                        <Setter Property="IsTabStop" Value="False" />
                        <Setter Property="Padding" Value="0" />
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="viewmodels:DSCConfigurationUnitViewModel">
                        <Expander IsExpanded="False"
                                  Tag="{x:Bind Id}"
                                  HorizontalContentAlignment="Left"
                                  HorizontalAlignment="Stretch">

                            <i:Interaction.Behaviors>
                                <ic:EventTriggerBehavior EventName="Loaded">
                                    <ic:InvokeCommandAction Command="{x:Bind LoadedCommand}" />
                                </ic:EventTriggerBehavior>
                            </i:Interaction.Behaviors>

                            <!-- Expander header -->
                            <Expander.Header>
                                <Grid Margin="0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0" HorizontalAlignment="Left" Spacing="2">

                                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Spacing="2">
                                            <TextBlock Text="{x:Bind Title}" TextTrimming="CharacterEllipsis" />
                                            <FontIcon Glyph="&#xEA18;"
                                                  VerticalAlignment="Center"
                                                  Visibility="{x:Bind RequiresElevation}" />

                                        </StackPanel>
                                        <TextBlock Text="{x:Bind Description}" TextTrimming="CharacterEllipsis" />
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                                        <Button Command="{Binding ValidateCommand}">
                                            Validate
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Expander.Header>

                            <!-- Expander content -->
                            <ScrollViewer HorizontalScrollMode="Auto" HorizontalScrollBarVisibility="Auto">
                                <StackPanel>
                                    <!-- Individual records -->
                                    <ListView Margin="{StaticResource BlockThickness}" Style="{StaticResource KeyValueSubList}" ItemTemplate="{StaticResource KeyValueTemplate}">
                                        <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_Id" Value="{x:Bind Id}" />
                                        <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_Intent" Value="{x:Bind Intent}" />
                                    </ListView>

                                    <!-- Dependencies -->
                                    <StackPanel Margin="{StaticResource BlockThickness}" Orientation="Horizontal" Visibility="{x:Bind Dependencies, Converter={StaticResource CollectionVisibilityConverter}}">
                                        <TextBlock x:Uid="ConfigurationUnit_Dependencies" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                                        <TextBlock Text=":" Margin="2,0" />
                                        <ListView Style="{StaticResource KeyValueSubList}" ItemsSource="{x:Bind Dependencies}">
                                            <ListView.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Spacing="2" Orientation="Horizontal" />
                                                </ItemsPanelTemplate>
                                            </ListView.ItemsPanel>
                                            <ListView.ItemTemplate>
                                                <DataTemplate x:DataType="x:String">
                                                    <TextBlock Tag="{x:Bind}">
                                                            <Hyperlink Click="Dependency_Click">
                                                                <Run Text="{x:Bind}" />
                                                            </Hyperlink>
                                                    </TextBlock>
                                                </DataTemplate>
                                            </ListView.ItemTemplate>
                                        </ListView>
                                    </StackPanel>

                                    <!-- Metadata -->
                                    <StackPanel Margin="{StaticResource BlockThickness}" Visibility="{x:Bind Metadata, Converter={StaticResource CollectionVisibilityConverter}}">
                                        <TextBlock x:Uid="ConfigurationUnit_ResourceMetadata" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                                        <ListView Style="{ThemeResource KeyValueSubList}" ItemTemplate="{ThemeResource KeyValueTemplate}" ItemsSource="{x:Bind Metadata}"/>
                                    </StackPanel>

                                    <!-- Settings -->
                                    <StackPanel Margin="{StaticResource BlockThickness}" Visibility="{x:Bind Settings, Converter={StaticResource CollectionVisibilityConverter}}">
                                        <TextBlock x:Uid="ConfigurationUnit_Settings" Style="{ThemeResource BodyStrongTextBlockStyle}" />
                                        <!--<ListView Style="{ThemeResource KeyValueSubList}" ItemTemplate="{ThemeResource KeyValueTemplate}" ItemsSource="{x:Bind Settings}"/>-->
                                        <TextBlock Text="{x:Bind SettingsString, Mode=OneWay}"/>
                                    </StackPanel>

                                    <!-- Details -->
                                    <StackPanel Margin="{StaticResource BlockThickness}" Visibility="{x:Bind Settings, Converter={StaticResource CollectionVisibilityConverter}}">
                                        <TextBlock x:Uid="ConfigurationUnit_Details" Style="{ThemeResource BodyStrongTextBlockStyle}" />

                                        <!-- Shimmers -->
                                        <StackPanel Visibility="{x:Bind Details, Mode=OneWay, Converter={StaticResource EmptyObjectToVisibilityConverter}}">

                                            <StackPanel.Resources>
                                                <Style TargetType="labs:Shimmer">
                                                    <Setter Property="Margin" Value="5" />
                                                    <Setter Property="Height" Value="{ThemeResource BodyTextBlockFontSize}" />
                                                </Style>
                                            </StackPanel.Resources>
                                            <labs:Shimmer />
                                            <labs:Shimmer />
                                            <labs:Shimmer />
                                            <labs:Shimmer />
                                            <labs:Shimmer />
                                        </StackPanel>

                                        <!-- Loaded details -->
                                        <ListView Style="{ThemeResource KeyValueSubList}" ItemTemplate="{StaticResource KeyValueTemplate}">
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_UnitType" Value="{x:Bind Details.UnitType, Mode=OneWay}" />
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_UnitDescription" Value="{x:Bind Details.UnitDescription, Mode=OneWay}" />
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_UnitDocumentation" Value="{x:Bind Details.UnitDocumentationUri, Mode=OneWay}" />
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_ModuleName" Value="{x:Bind Details.ModuleName, Mode=OneWay}" />
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_ModuleSource" Value="{x:Bind Details.ModuleSource, Mode=OneWay}" />
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_ModuleDescription" Value="{x:Bind Details.ModuleDescription, Mode=OneWay}" />
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_ModuleDocumentationUri" Value="{x:Bind Details.ModuleDocumentationUri, Mode=OneWay}" />
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_PublishedModuleUri" Value="{x:Bind Details.PublishedModuleUri, Mode=OneWay}" />
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_Version" Value="{x:Bind Details.Version, Mode=OneWay}" />
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_Author" Value="{x:Bind Details.Author, Mode=OneWay}" />
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_Publisher" Value="{x:Bind Details.Publisher, Mode=OneWay}" />
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_IsLocal" Value="{x:Bind Details.IsLocal, Mode=OneWay}" />
                                            <models:ConfigurationUnitDataEntry x:Uid="ConfigurationUnit_IsPublic" Value="{x:Bind Details.IsPublic, Mode=OneWay}" />
                                        </ListView>
                                    </StackPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </Expander>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>

        <Grid Grid.Row="3" Visibility="{x:Bind ViewModel.IsInEditMode, Mode=OneWay}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="2*"/>
            </Grid.ColumnDefinitions>
            
            <ListView
                ItemsSource="{x:Bind ViewModel.ConfigurationUnits}"
                SelectedItem="{x:Bind ViewModel.SelectedUnit, Mode=TwoWay}"
                Grid.Column="0"
                Margin="0">

                <ListView.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Spacing="12" />
                    </ItemsPanelTemplate>
                </ListView.ItemsPanel>
                <ListView.ItemTemplate>
                    <DataTemplate>

                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                CornerRadius="4"
                                Padding="4">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Spacing="8" Grid.Column="0">
                                    <TextBlock>
                                        <Run x:Uid="PreviewPage_Name"/>
                                        <Run Text="{Binding Title}"/>
                                    </TextBlock>
                                    <TextBlock>
                                        <Run x:Uid="PreviewPage_Description"/>
                                        <Run Text="{Binding Description}"/>
                                    </TextBlock>
                                </StackPanel>
                                <Button Grid.Column="1"
                                        Command="{Binding ElementName=RootPage, Path=ViewModel.RemoveResourceCommand, Mode=OneWay}"
                                        CommandParameter="{Binding}">
                                    <FontIcon Glyph="&#xE894;" FontSize="14"/>
                                </Button>
                            </Grid>
                        </Border>

                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <ScrollView
                Grid.Column="1"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                Background="{StaticResource CardBackgroundFillColorDefaultBrush}"
                Visibility="{x:Bind ViewModel.IsEditPanelVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                <StackPanel Spacing="24" Padding="16">
                    <TextBox
                        x:Uid="PreviewPage_ModuleHeader"
                        Text="{x:Bind ViewModel.SelectedUnit.Type, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        Height="Auto"/>

                    <TextBox
                        x:Uid="PreviewPage_DescriptionHeader"
                        Text="{x:Bind ViewModel.SelectedUnit.Description, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        Height="Auto"/>

                    <userControls:ConfigurationSettings Properties="{x:Bind ViewModel.SelectedUnit.Properties, Mode=OneWay}" />

                </StackPanel>
            </ScrollView>
        </Grid>

        <Grid Grid.Row="4">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <StackPanel Grid.Column="0" HorizontalAlignment="Left" Orientation="Horizontal" Spacing="8">
                <Button x:Uid="ManagePage_AddResourceButtonText"
                        Command="{x:Bind ViewModel.AddResourceCommand}"
                        Visibility="{x:Bind ViewModel.IsInEditMode, Mode=OneWay}"/>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
                <Button x:Uid="ManagePage_SaveButtonText"
                        Command="{x:Bind ViewModel.SaveCommand}"
                        IsEnabled="True"
                        Visibility="{x:Bind ViewModel.IsInEditMode, Mode=OneWay}"/>
                <Button x:Uid="ManagePage_SaveAsButtonText"
                        Command="{x:Bind ViewModel.SaveAsCommand}"
                        IsEnabled="True"
                        Visibility="{x:Bind ViewModel.IsInEditMode, Mode=OneWay}"/>
                <Button x:Uid="ManagePage_ApplyButtonText"
                        Style="{ThemeResource AccentButtonStyle}"
                        Click="ShowApplyDialog"
                        IsEnabled="{x:Bind ViewModel.CanApply, Mode=OneWay}"
                        HorizontalAlignment="Right"
                        Margin="8"/>
            </StackPanel>
        </Grid>

    </Grid>
</Page>
