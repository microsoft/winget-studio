trigger:
- main

parameters:
- name: SignOutput
  type: boolean
  default: False
- name: Platforms
  type: object
  default:
  - x86
  - x64
  - arm64
- name: Configurations
  type: object
  default:
  - Debug
  - Release

variables:
  - template: /.pipelines/variables/global.yml@self

resources:
  repositories:
  - repository: templates
    type: git
    name: OneBranch.Pipelines/GovernedTemplates
    ref: refs/heads/main

extends:
  template: v2/Microsoft.NonOfficial.yml@templates
  parameters:
    platform:
      name: 'windows_undocked'
    git:
      fetchTags: false
    stages:
    - stage: Build_WinGetStudio
      dependsOn: []
      jobs:
      - ${{ each configuration in parameters.Configurations }}:
        - ${{ each platform in parameters.Platforms }}:
          - job: Build_${{ platform }}_${{ configuration }}
            pool:
              type: windows
            variables:
              runCodesignValidationInjection: false
              skipComponentGovernanceDetection: true
              ob_outputDirectory: $(Build.ArtifactStagingDirectory)\winget-studio
              ob_artifactBaseName: msix_${{ platform }}_${{ configuration }}
            timeoutInMinutes: 120
            steps:
            - template: /.pipelines/steps/build-msix.yml@self
              parameters:
                Platform: ${{ platform }}
                Configuration: ${{ configuration }}
                BuildingBranch: 'main'
                OutputDir: '$(ob_outputDirectory)'
                SignOutput: ${{ parameters.SignOutput }}

    - stage: Build_MsixBundle
      dependsOn: [Build_WinGetStudio]
      condition: in(dependencies.Build_WinGetStudio.result, 'Succeeded')
      jobs:
      - job: Build_MsixBundles
        pool:
          type: windows
        variables:
          runCodesignValidationInjection: false
          skipComponentGovernanceDetection: true
          ob_outputDirectory: $(Build.ArtifactStagingDirectory)\winget-studio
          ob_artifactBaseName: msixbundle_wingetstudio
        steps:
        - ${{ each configuration in parameters.Configurations }}:
          - ${{ each platform in parameters.Platforms }}:
            - task: DownloadPipelineArtifact@2
              displayName: Download msix_${{ platform }}_${{ configuration }}
              inputs:
                buildType: 'current'
                artifactName: msix_${{ platform }}_${{ configuration }}
                targetPath: '$(ob_outputDirectory)'

          - template: /.pipelines/steps/build-msixbundle.yml@self
            parameters:
              Configuration: ${{ configuration }}
              OutputDir: '$(ob_outputDirectory)'
              SignOutput: ${{ parameters.SignOutput }}